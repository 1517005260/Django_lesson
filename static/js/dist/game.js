class GameMenu{constructor(t){this.root=t,this.$menu=$('\n        <div class="game-menu">\n        <div class="game-menu-field">\n            <div class="game-menu-field-item game-menu-field-item-single-mode">\n                人机对战\n            </div>\n            <br>\n            <div class="game-menu-field-item game-menu-field-item-multi-mode">\n                多人对战\n            </div>\n            <br>\n            <div class="game-menu-field-item game-menu-field-item-settings">\n                退出\n            </div>\n        </div>\n        </div>\n        '),this.root.$game.append(this.$menu),this.$single_mode=this.$menu.find(".game-menu-field-item-single-mode"),this.$multi_mode=this.$menu.find(".game-menu-field-item-multi-mode"),this.$settings=this.$menu.find(".game-menu-field-item-settings"),this.$menu.hide(),this.start()}start(){this.events()}events(){let t=this;this.$menu.on("contextmenu",(function(){return!1})),this.$single_mode.on("click",(function(){t.hide(),t.root.playground.show("single mode")})),this.$multi_mode.on("click",(function(){t.hide(),t.root.playground.show("multi mode")})),this.$settings.on("click",(function(){t.root.settings.sign_out()}))}hide(){this.$menu.hide()}show(){this.$menu.show()}}let Game_Objects=[];class GameObject{constructor(){Game_Objects.push(this),this.has_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}create_uuid(){let t="";for(let s=0;s<8;s++){t+=parseInt(Math.floor(10*Math.random()))}return t}start(){}update(){}late_update(){}on_destroy(){}destroy(){this.on_destroy();for(let t=0;t<Game_Objects.length;t++)if(Game_Objects[t]===this){Game_Objects.splice(t,1);break}}}let last_timestamp=0,Game_Animation=function(t){for(let s=0;s<Game_Objects.length;s++){let i=Game_Objects[s];i.has_called_start?(i.timedelta=t-last_timestamp,i.update()):(i.has_called_start=!0,i.start())}for(let t=0;t<Game_Objects.length;t++){Game_Objects[t].late_update()}last_timestamp=t,requestAnimationFrame(Game_Animation)};requestAnimationFrame(Game_Animation);class ChatField{constructor(t){this.root=t,this.$history=$('<div class="game-chat-field-history">历史记录</div>'),this.$input=$('<input type="text" class="game-chat-field-input" placeholder="Enter键入信息/Esc关闭">'),this.$history.hide(),this.func_id=null,this.root.$playground.append(this.$history),this.root.$playground.append(this.$input),this.start()}start(){this.events()}events(){let t=this;this.$input.on("keydown",(function(s){if(27===s.which)return t.hide_input(),!1;if(13===s.which){let s=t.root.root.settings.username,i=t.$input.val();return i&&(t.$input.val(""),t.add_message(s,i),t.root.mps.send_message(s,i)),!1}}))}add_message(t,s){this.show_history();let i=`@${t}: ${s}`;this.$history.append(this.html_message(i)),this.$history.scrollTop(this.$history[0].scrollHeight)}html_message(t){return $(`<div>${t}</div>`)}show_history(){let t=this;this.$history.fadeIn(),this.func_id&&clearTimeout(this.func_id),this.func_id=setTimeout((function(){t.$history.fadeOut(),t.func_id=null}),3e3)}show_input(){this.show_history(),this.$input.show(),this.$input.focus()}hide_input(){this.$input.hide(),this.root.game_map.$canvas.focus()}}class GameMap extends GameObject{constructor(t){super(),this.root=t,this.$canvas=$("<canvas tabindex=0></canvas>"),this.ctx=this.$canvas[0].getContext("2d"),this.ctx.canvas.width=this.root.width,this.ctx.canvas.height=this.root.height,this.root.$playground.append(this.$canvas)}start(){this.$canvas.focus()}resize(){this.ctx.canvas.width=this.root.width,this.ctx.canvas.height=this.root.height,this.ctx.fillStyle="rgba(0,0,0,1)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}update(){this.render()}render(){this.ctx.fillStyle="rgba(0,0,0,0.2)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}}class NoticeBoard extends GameObject{constructor(t){super(),this.root=t,this.ctx=this.root.game_map.ctx,this.text="已就绪：0人"}start(){}write(t){this.text=t}update(){this.render()}render(){this.ctx.font="20px serif",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText(this.text,this.root.width/2,20)}}class Particle extends GameObject{constructor(t,s){super(),this.root=t,this.ctx=this.root.game_map.ctx,this.x=s.x,this.y=s.y,this.radius=s.radius,this.vx=s.vx,this.vy=s.vy,this.color=s.color,this.speed=s.speed,this.move_length=s.move_length,this.f=.9,this.eps=.01,this.start()}start(){}update(){if(this.move_length<this.eps||this.speed<this.eps)return this.destroy(),!1;let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.speed*=this.f,this.move_length-=t,this.render()}render(){let t=this.root.scale;this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class Player extends GameObject{constructor(t,s){super(),this.root=t,this.ctx=this.root.game_map.ctx,this.x=s.x,this.y=s.y,this.vx=0,this.vy=0,this.speed=s.speed,this.radius=s.radius,this.color=s.color,this.character=s.character,this.username=s.username,this.photo=s.photo,this.move_length=0,this.eps=.01,this.cur_skill=null,this.spent_time=0,this.f=.9,this.damage_vx=0,this.damage_vy=0,this.damage_speed=0,this.fireballs=[],"robot"!==this.character&&(this.img=new Image,this.img.src=this.photo),"me"===this.character&&(this.fireball_coldtime=2,this.fireball_img=new Image,this.fireball_img.src="https://cdn.acwing.com/media/article/image/2021/12/02/1_9340c86053-fireball.png",this.blink_coldtime=0,this.blink_img=new Image,this.blink_img.src="https://cdn.acwing.com/media/article/image/2021/12/02/1_daccabdc53-blink.png")}start(){if(this.root.player_count++,this.root.notice_board.write("已就绪："+this.root.player_count+"人/3人"),this.root.player_count>=3&&(this.root.state="fighting",this.root.notice_board.write("Fighting!")),"me"===this.character)this.events();else if("robot"===this.character){let t=Math.random()*this.root.width/this.root.scale,s=Math.random()*this.root.height/this.root.scale;this.move_to(t,s)}}events(){let t=this;this.root.root.os?this.root.game_map.$canvas.on("contextmenu",(function(){return!1})):$(window).on("contextmenu",(function(){return!1})),this.root.game_map.$canvas.on("mousedown",(function(s){if("fighting"!==t.root.state)return!0;const i=t.ctx.canvas.getBoundingClientRect();if(1===s.which){let e=(s.clientX-i.left)/t.root.scale,h=(s.clientY-i.top)/t.root.scale;if("fireball"===t.cur_skill){if(t.fireball_coldtime>0)return!1;let s=t.shoot_fireball(e,h);"multi mode"===t.root.mode&&t.root.mps.send_shoot_fireball(e,h,s.uuid)}else if("blink"===t.cur_skill){if(t.blink_coldtime>0)return!1;t.blink(e,h),"multi mode"===t.root.mode&&t.root.mps.send_blink(e,h)}t.cur_skill=null}else{if(2===s.which)return!1;if(3===s.which){let e=(s.clientX-i.left)/t.root.scale,h=(s.clientY-i.top)/t.root.scale;t.move_to(e,h),"multi mode"===t.root.mode&&t.root.mps.send_move_to(e,h)}}})),this.root.game_map.$canvas.on("keydown",(function(s){if(13===s.which){if("multi mode"===t.root.mode)return t.root.chat_field.show_input(),!1}else 27===s.which&&"multi mode"===t.root.mode&&t.root.chat_field.hide_input();return"fighting"!==t.root.state||(81===s.which?t.fireball_coldtime>0||(t.cur_skill="fireball",!1):70===s.which?t.blink_coldtime>0||(t.cur_skill="blink",!1):void 0)}))}shoot_fireball(t,s){let i=Math.atan2(s-this.y,t-this.x),e=new FireBall(this.root,{player:this,x:this.x,y:this.y,radius:.01,vx:Math.cos(i),vy:Math.sin(i),color:"orange",speed:.6,move_length:1,damage:.01});return this.fireball_coldtime=2,this.fireballs.push(e),e}destroy_fireball(t){for(let s=0;s<this.fireballs.length;s++){let i=this.fireballs[s];if(t===i.uuid){i.destroy();break}}}blink(t,s){let i=this.get_dist(this.x,this.y,t,s);i=Math.min(i,.15);let e=Math.atan2(s-this.y,t-this.x);this.x+=i*Math.cos(e),this.y+=i*Math.sin(e),this.blink_coldtime=12,this.move_length=0}get_dist(t,s,i,e){let h=i-t,a=e-s;return Math.sqrt(h*h+a*a)}move_to(t,s){this.move_length=this.get_dist(this.x,this.y,t,s);let i=Math.atan2(s-this.y,t-this.x);this.vx=Math.cos(i),this.vy=Math.sin(i)}is_attacked(t,s){for(let t=0;t<10*Math.random()+20;t++){let t=2*Math.PI*Math.random();new Particle(this.root,{x:this.x,y:this.y,radius:.1*this.radius*Math.random(),vx:Math.cos(t),vy:Math.sin(t),color:this.color,speed:10*this.speed,move_length:5*this.radius*Math.random()})}if(this.radius-=s,this.radius<this.eps)return this.destroy(),!1;this.damage_vx=Math.cos(t),this.damage_vy=Math.sin(t),this.damage_speed=100*s,this.speed*=1.2}receive_attack(t,s,i,e,h,a){a.destroy_fireball(h),this.x=t,this.y=s,this.is_attacked(i,e)}update(){this.spent_time+=this.timedelta/1e3,this.update_win(),this.update_move(),"me"===this.character&&"fighting"===this.root.state&&this.update_coldtime(),this.render()}update_win(){"fighting"===this.root.state&&"me"===this.character&&1===this.root.players.length&&(this.root.state="over",this.root.score_board.win())}update_coldtime(){this.fireball_coldtime=Math.max(0,this.fireball_coldtime-this.timedelta/1e3),this.blink_coldtime=Math.max(0,this.blink_coldtime-this.timedelta/1e3)}update_move(){if("robot"===this.character&&this.spent_time>4&&Math.random()<1/120){let t=this.root.players[Math.floor(Math.random()*this.root.players.length)],s=t.x+t.speed*t.vx*t.timedelta/1e3*.3,i=t.y+t.speed*t.vy*t.timedelta/1e3*.3;this.shoot_fireball(s,i)}if(this.damage_speed>this.eps)this.vx=this.vy=0,this.move_length=0,this.x+=this.damage_vx*this.damage_speed*this.timedelta/1e3,this.y+=this.damage_vy*this.damage_speed*this.timedelta/1e3,this.damage_speed*=this.f;else if(this.move_length<this.eps){if(this.move_length=0,this.vx=this.vy=0,"robot"===this.character){let t=Math.random()*this.root.width/this.root.scale,s=Math.random()*this.root.height/this.root.scale;this.move_to(t,s)}}else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}}render(){let t=this.root.scale;"robot"!==this.character?(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,(this.x-this.radius)*t,(this.y-this.radius)*t,2*this.radius*t,2*this.radius*t),this.ctx.restore()):(this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()),"me"===this.character&&"fighting"===this.root.state&&this.render_skill_coldtime()}render_skill_coldtime(){let t=this.root.scale,s=1.5,i=.9,e=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(s*t,i*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.fireball_img,(s-e)*t,(i-e)*t,2*e*t,2*e*t),this.ctx.restore();let h=1.5,a=.96;this.ctx.font="12px Arial",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText("Q",h*t,a*t),this.fireball_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(s*t,i*t),this.ctx.arc(s*t,i*t,e*t,0-Math.PI/2,2*Math.PI*(1-this.fireball_coldtime/2)-Math.PI/2,!0),this.ctx.lineTo(s*t,i*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill()),s=1.62,i=.9,e=.04,this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(s*t,i*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.blink_img,(s-e)*t,(i-e)*t,2*e*t,2*e*t),this.ctx.restore(),h=1.62,a=.96,this.ctx.font="12px Arial",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText("F",h*t,a*t),this.blink_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(s*t,i*t),this.ctx.arc(s*t,i*t,e*t,0-Math.PI/2,2*Math.PI*(1-this.blink_coldtime/12)-Math.PI/2,!0),this.ctx.lineTo(s*t,i*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill())}on_destroy(){"me"===this.character&&"fighting"===this.root.state&&(this.root.state="over",this.root.score_board.lose());for(let t=0;t<this.root.players.length;t++)if(this===this.root.players[t]){this.root.players.splice(t,1);break}}}class ScoreBoard extends GameObject{constructor(t){super(),this.root=t,this.ctx=this.root.game_map.ctx,this.state=null,this.win_img=new Image,this.win_img.src="https://cdn.acwing.com/media/article/image/2021/12/17/1_8f58341a5e-win.png",this.lose_img=new Image,this.lose_img.src="https://app6534.acapp.acwing.com.cn/static/image/game/lose.png"}start(){}events(){let t=this;this.root.game_map&&this.root.game_map.$canvas.on("click",(function(){t.root.hide(),t.root.root.menu.show()}))}win(){this.state="win";let t=this;setTimeout((function(){t.events()}),1e3)}lose(){this.state="lose";let t=this;setTimeout((function(){t.events()}),1e3)}late_update(){this.render()}render(){let t=this.root.height/2;"win"===this.state?this.ctx.drawImage(this.win_img,this.root.width/2-t/2,this.root.height/2-t/2,t,t):"lose"===this.state&&this.ctx.drawImage(this.lose_img,this.root.width/2-t/2,this.root.height/2-t/2,t,t)}}class FireBall extends GameObject{constructor(t,s){super(),this.root=t,this.player=s.player,this.ctx=this.root.game_map.ctx,this.x=s.x,this.y=s.y,this.vx=s.vx,this.vy=s.vy,this.radius=s.radius,this.color=s.color,this.speed=s.speed,this.move_length=s.move_length,this.damage=s.damage,this.eps=.01,this.start()}start(){}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!==this.player.character&&this.update_attack(),this.render()}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}update_attack(){for(let t=0;t<this.root.players.length;t++){let s=this.root.players[t];if(this.player!=s&&this.is_collision(s)){this.attack(s);break}}}get_dist(t,s,i,e){let h=i-t,a=e-s;return Math.sqrt(h*h+a*a)}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<this.radius+t.radius}attack(t){let s=Math.atan2(t.y-this.y,t.x-this.x);t.is_attacked(s,this.damage),"multi mode"===this.root.mode&&this.root.mps.send_attack(t.uuid,t.x,t.y,s,this.damage,this.uuid),this.destroy()}render(){let t=this.root.scale;this.ctx.beginPath(),this.ctx.arc(this.x*t,this.y*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}on_destroy(){let t=this.player.fireballs;for(let s=0;s<t.length;s++)if(this===t[s]){t.splice(s,1);break}}}class MultiPlayerSocket{constructor(t){this.root=t,this.ws=new WebSocket("wss://app6534.acapp.acwing.com.cn/wss/multiplayer/?token="+t.root.access),this.start()}get_player(t){let s=this.root.players;for(let i=0;i<s.length;i++){let e=s[i];if(t===e.uuid)return e}return null}start(){this.receive()}receive(){let t=this;this.ws.onmessage=function(s){let i=JSON.parse(s.data);if(i.uuid===t.uuid)return!1;"create_player"===i.event?t.receive_create_player(i.uuid,i.username,i.photo):"move_to"===i.event?t.receive_move_to(i.uuid,i.tx,i.ty):"shoot_fireball"===i.event?t.receive_shoot_fireball(i.uuid,i.tx,i.ty,i.ball_uuid):"attack"===i.event?t.receive_attack(i.uuid,i.attackee_uuid,i.x,i.y,i.sita,i.damage,i.ball_uuid):"blink"===i.event?t.receive_blink(i.uuid,i.tx,i.ty):"message"===i.event&&t.receive_message(i.uuid,i.username,i.text)}}send_create_player(t,s){this.ws.send(JSON.stringify({event:"create_player",uuid:this.uuid,username:t,photo:s}))}receive_create_player(t,s,i){let e=new Player(this.root,{x:this.root.width/2/this.root.scale,y:.5,radius:.05,color:"white",speed:.15,character:"enemy",username:s,photo:i});e.uuid=t,this.root.players.push(e)}send_move_to(t,s){this.ws.send(JSON.stringify({event:"move_to",uuid:this.uuid,tx:t,ty:s}))}receive_move_to(t,s,i){let e=this.get_player(t);e&&e.move_to(s,i)}send_shoot_fireball(t,s,i){this.ws.send(JSON.stringify({event:"shoot_fireball",uuid:this.uuid,tx:t,ty:s,ball_uuid:i}))}receive_shoot_fireball(t,s,i,e){let h=this.get_player(t);if(h){h.shoot_fireball(s,i).uuid=e}}send_attack(t,s,i,e,h,a){this.ws.send(JSON.stringify({event:"attack",uuid:this.uuid,attackee_uuid:t,x:s,y:i,sita:e,damage:h,ball_uuid:a}))}receive_attack(t,s,i,e,h,a,o){let r=this.get_player(t),n=this.get_player(s);r&&n&&n.receive_attack(i,e,h,a,o,r)}send_blink(t,s){this.ws.send(JSON.stringify({event:"blink",uuid:this.uuid,tx:t,ty:s}))}receive_blink(t,s,i){let e=this.get_player(t);e&&e.blink(s,i)}send_message(t,s){this.ws.send(JSON.stringify({event:"message",uuid:this.uuid,username:t,text:s}))}receive_message(t,s,i){this.root.chat_field.add_message(s,i)}}class GamePlayground{constructor(t){this.root=t,this.$playground=$('\n        <div class="game-playground"><div>\n        '),this.root.$game.append(this.$playground),this.width=this.$playground.width(),this.height=this.$playground.height(),this.hide(),this.start()}get_random_color(){let t=["blue","pink","red","grey","green","yellow","purple"];return t[Math.floor(Math.random()*t.length)]}create_uuid(){let t="";for(let s=0;s<8;s++){t+=parseInt(Math.floor(10*Math.random()))}return t}start(){let t=this,s=this.create_uuid();$(window).on(`resize.${s}`,(function(){t.resize()})),this.root.os&&t.root.os.api.window.on_close((function(){$(window).off(`resize.${s}`),t.hide()}))}resize(){this.width=this.$playground.width(),this.height=this.$playground.height();let t=Math.min(this.width/16,this.height/9);this.width=16*t,this.height=9*t,this.scale=this.height,this.game_map&&this.game_map.resize()}show(t){let s=this;if(this.$playground.show(),this.game_map=new GameMap(this),this.resize(),this.mode=t,this.state="waiting",this.notice_board=new NoticeBoard(this),this.score_board=new ScoreBoard(this),this.player_count=0,this.players=[],this.players.push(new Player(this,{x:this.width/2/this.scale,y:.5,radius:.05,color:"white",speed:.15,character:"me",username:this.root.settings.username,photo:this.root.settings.photo})),"single mode"===t)for(let t=0;t<5;t++)this.players.push(new Player(this,{x:this.width/2/this.scale,y:.5,radius:.05,color:this.get_random_color(),speed:.15,character:"robot"}));else"multi mode"===t&&(this.chat_field=new ChatField(this),this.mps=new MultiPlayerSocket(this),this.mps.uuid=this.players[0].uuid,this.mps.ws.onopen=function(){s.mps.send_create_player(s.root.settings.username,s.root.settings.photo)})}hide(){for(;this.players&&this.players.length>0;)this.players[0].destroy();this.game_map&&(this.game_map.destroy(),this.game_map=null),this.notice_board&&(this.notice_board.destroy(),this.notice_board=null),this.score_board&&(this.score_board.destroy(),this.score_board=null),this.$playground.empty(),this.$playground.hide()}}class Settings{constructor(t){this.root=t,this.platform="WEB",this.root.os&&(this.platform="ACAPP"),this.username="",this.photo="",this.$settings=$('\n    <div class="game-settings">\n        <div class="game-settings-login">\n            <div class="game-settings-title">\n                登录\n            </div>\n            <div class="game-settings-username">\n                <div class="game-settings-item">\n                    <input type="text" placeholder="用户名">\n                </div>\n            </div>\n            <div class="game-settings-password">\n                <div class="game-settings-item">\n                    <input type="password" placeholder="密码">\n                </div>\n            </div>\n            <div class="game-settings-submit">\n                <div class="game-settings-item">\n                    <button>登录</button>\n                </div>\n            </div>\n            <div class="game-settings-error-message">\n            </div>\n            <div class="game-settings-option">\n                注册\n            </div>\n            <br>\n            <div class="game-settings-third-part">\n                <img width="30" src="https://app165.acapp.acwing.com.cn/static/image/settings/acwing_logo.png">\n                <br>\n                <div>第三方一键登录</div>\n            </div>\n        </div>\n        <div class="game-settings-register">\n            <div class="game-settings-title">\n                注册\n            </div>\n            <div class="game-settings-username">\n                <div class="game-settings-item">\n                    <input type="text" placeholder="用户名">\n                </div>\n            </div>\n            <div class="game-settings-password-first">\n                <div class="game-settings-item">\n                    <input type="password" placeholder="密码">\n                </div>\n            </div>\n            <div class="game-settings-password-second">\n                <div class="game-settings-item">\n                    <input type="password" placeholder="确认密码">\n                </div>\n            </div>\n            <div class="game-settings-submit">\n                <div class="game-settings-item">\n                    <button>注册</button>\n                </div>\n            </div>\n            <div class="game-settings-error-message">\n            </div>\n            <div class="game-settings-option">\n                登录\n            </div>\n            <br>\n            <div class="game-settings-third-part">\n                <img width="30" src="https://app165.acapp.acwing.com.cn/static/image/settings/acwing_logo.png">\n                <br>\n                <div>第三方一键登录</div>\n            </div>\n        </div>\n    </div>'),this.root.$game.append(this.$settings),this.$login=this.$settings.find(".game-settings-login"),this.$login_username=this.$login.find(".game-settings-username input"),this.$login_password=this.$login.find(".game-settings-password input"),this.$login_submit=this.$login.find(".game-settings-submit button"),this.$login_error_message=this.$login.find(".game-settings-error-message"),this.$login_register=this.$login.find(".game-settings-option"),this.$login.hide(),this.$register=this.$settings.find(".game-settings-register"),this.$register_username=this.$register.find(".game-settings-username input"),this.$register_password=this.$register.find(".game-settings-password-first input"),this.$register_password_confirm=this.$register.find(".game-settings-password-second input"),this.$register_submit=this.$register.find(".game-settings-submit button"),this.$register_error_message=this.$register.find(".game-settings-error-message"),this.$register_login=this.$register.find(".game-settings-option"),this.$register.hide(),this.$third_part_login=this.$settings.find(".game-settings-third-part img"),this.start()}start(){"ACAPP"===this.platform?this.getinfo_acapp():(this.root.access?(this.getinfo_web(),this.refresh_jwt()):this.login(),this.events())}refresh_jwt(){let t=this;setInterval((function(){$.ajax({url:"https://app6534.acapp.acwing.com.cn/settings/token/refresh/",type:"POST",data:{refresh:t.root.refresh},success:function(s){t.root.access=s.access}})}),27e4)}events(){this.events_login(),this.events_register();let t=this;this.$third_part_login.on("click",(function(){t.third_part_login_web()}))}events_login(){let t=this;this.$login_register.on("click",(function(){t.register()})),this.$login_submit.on("click",(function(){t.sign_in()}))}events_register(){let t=this;this.$register_login.on("click",(function(){t.login()})),this.$register_submit.on("click",(function(){t.new_register()}))}third_part_login_web(){$.ajax({url:"https://app6534.acapp.acwing.com.cn/settings/acwing/web/apply_code/",type:"GET",success:function(t){"success"===t.result&&window.location.replace(t.apply_code_url)}})}third_part_login_acapp(t,s,i,e){let h=this;this.root.os.api.oauth2.authorize(t,s,i,e,(function(t){"success"===t.result&&(h.username=t.username,h.photo=t.photo,h.hide(),h.root.menu.show(),h.root.access=t.access,h.root.refresh=t.refresh,h.refresh_jwt())}))}sign_in(t,s){let i=this;t=t||this.$login_username.val(),s=s||this.$login_password.val(),this.$login_error_message.empty(),$.ajax({url:"https://app6534.acapp.acwing.com.cn/settings/token/",type:"POST",data:{username:t,password:s},success:function(t){i.root.access=t.access,i.root.refresh=t.refresh,i.refresh_jwt(),i.getinfo_web()},error:function(){i.$login_error_message.html("用户名或密码错误")}})}new_register(){let t=this,s=this.$register_username.val(),i=this.$register_password.val(),e=this.$register_password_confirm.val();this.$register_error_message.empty(),$.ajax({url:"https://app6534.acapp.acwing.com.cn/settings/register/",type:"post",data:{username:s,password:i,password_confirm:e},success:function(e){"success"===e.result?t.sign_in(s,i):t.$register_error_message.html(e.result)}})}sign_out(){"ACAPP"===this.platform?this.root.os.api.window.close():(this.root.access="",this.root.refresh="",location.href="/")}register(){this.$login.hide(),this.$register.show()}login(){this.$register.hide(),this.$login.show()}getinfo_web(){let t=this;$.ajax({url:"https://app6534.acapp.acwing.com.cn/settings/getinfo/",type:"GET",data:{platform:t.platform},headers:{Authorization:"Bearer "+t.root.access},success:function(s){"success"===s.result?(t.username=s.username,t.photo=s.photo,t.hide(),t.root.menu.show()):t.login()}})}getinfo_acapp(){let t=this;$.ajax({url:"https://app6534.acapp.acwing.com.cn/settings/acwing/acapp/apply_code/",type:"GET",success:function(s){"success"===s.result&&t.third_part_login_acapp(s.appid,s.redirect_uri,s.scope,s.state)}})}hide(){this.$settings.hide()}show(){this.$settings.show()}}export class Game{constructor(t,s,i,e){this.id=t,this.$game=$("#"+t),this.os=s,this.access=i,this.refresh=e,this.settings=new Settings(this),this.menu=new GameMenu(this),this.playground=new GamePlayground(this),this.start()}start(){}}
